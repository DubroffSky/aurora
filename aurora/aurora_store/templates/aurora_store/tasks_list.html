{% extends 'aurora_store/base.html' %}

{% block title %}Tasks - TaskFlow{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">My Tasks</h3>
                {% if request.user.is_staff %}
                <a href="{% url 'aurora_store:task_create' %}" class="btn btn-primary">Create New Task</a>
                {% endif %}
            </div>
            <div class="card-body">
                {% if tasks %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th class="tasks-list-hide-mobile">Project</th>
                                <th class="tasks-list-hide-mobile">Assigned To</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th class="tasks-list-hide-mobile">Deadline</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr>
                                <td>
                                    <strong>{{ task.title }}</strong>
                                    {% if task.description %}
                                        <br><small>{{ task.description|truncatewords:10 }}</small>
                                    {% endif %}
                                </td>
                                <td class="tasks-list-hide-mobile">
                                    <span class="badge badge-info">{{ task.project.title }}</span>
                                </td>
                                <td class="tasks-list-hide-mobile">
                                    {% if task.assigned_to %}
                                        {{ task.assigned_to.username }}
                                    {% else %}
                                        <span>Unassigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge badge-{% if task.priority == 'urgent' %}danger{% elif task.priority == 'high' %}warning{% elif task.priority == 'medium' %}info{% else %}secondary{% endif %}">
                                        {{ task.get_priority_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-{% if task.status == 'completed' %}success{% elif task.status == 'in_progress' %}warning{% elif task.status == 'review' %}info{% else %}secondary{% endif %} status-badge" data-task-id="{{ task.id }}">
                                        {{ task.get_status_display }}
                                    </span>
                                </td>
                                <td class="tasks-list-hide-mobile">
                                    {% if task.deadline %}
                                        {{ task.deadline|date:"Y-m-d" }}
                                    {% else %}
                                        <span class="text-muted">No deadline</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if request.user == task.created_by or request.user == task.project.owner %}
                                        <a href="{% url 'aurora_store:task_edit' task.id %}" class="btn btn-outline-primary">Edit</a>
                                    {% endif %}

                                    <a href="{% url 'aurora_store:task_view' task.id %}" class="btn btn-outline-secondary">View</a>
                                    <a href="{% url 'aurora_store:task_delete' task.id %}" class="btn btn-outline-danger" title="Delete">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align: middle;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 7h12M9 7V5a2 2 0 012-2h2a2 2 0 012 2v2m2 0v12a2 2 0 01-2 2H8a2 2 0 01-2-2V7h12z" />
                                            <line x1="10" y1="11" x2="10" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            <line x1="14" y1="11" x2="14" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </a>
                                </td>
                            </tr>
                                
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.status-badge').forEach(function(badge) {
        badge.addEventListener('mouseenter', function() {
            var taskId = badge.getAttribute('data-task-id');
            var select = document.querySelector('.status-select[data-task-id="' + taskId + '"]');
            if (select) {
                select.style.display = 'inline-block';
                badge.style.display = 'none';
                select.focus();
            }
        });
    });
    document.querySelectorAll('.status-select').forEach(function(select) {
        select.addEventListener('mouseleave', function() {
            var taskId = select.getAttribute('data-task-id');
            var badge = document.querySelector('.status-badge[data-task-id="' + taskId + '"]');
            if (badge) {
                select.style.display = 'none';
                badge.style.display = 'inline-block';
            }
        });
        select.addEventListener('change', function() {
            select.form.submit();
        });
        select.addEventListener('blur', function() {
            var taskId = select.getAttribute('data-task-id');
            var badge = document.querySelector('.status-badge[data-task-id="' + taskId + '"]');
            if (badge) {
                select.style.display = 'none';
                badge.style.display = 'inline-block';
            }
        });
    });
});
</script>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="text-center">
                        <h4>No tasks found</h4>
                        <p>Create your first task to get started!</p>
                        {% if request.user.is_staff %}
                        <a href="{% url 'aurora_store:task_create' %}" class="btn btn-primary">Create Task</a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %} 