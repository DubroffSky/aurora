{% extends 'aurora_store/base.html' %}
{% block title %}Chat{% endblock %}
{% block content %}
<style>
.chat-container {
    max-width: 900px;
    width: 100%;
    margin: 0 auto;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 2px 16px rgba(35,64,142,0.08);
    padding: 1em 1em;
    box-sizing: border-box;
}
.chat-messages {
    border: none;
    background: #f4f6fa;
    border-radius: 12px;
    padding: 1em;
    min-height: 400px;
    max-height: 60vh;
    height: 600px;
    overflow-y: auto;
    margin-bottom: 1em;
    scroll-behavior: smooth;
    box-sizing: border-box;
}
.msg-row {
    display: flex;
    align-items: flex-end;
    margin-bottom: 0.7em;
}
.attach-btn {
    font-size: 1.4em;
    cursor: pointer;
    padding: 0.3em;
    border-radius: 8px;
    transition: background 0.2s;
}
.attach-btn:hover {
    background: #f0f0f0;
}

/* –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ */
.send-btn {
    background: #23408e;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.7em 1em;
    font-size: 1.2em;
    cursor: pointer;
    transition: background 0.2s;
}
.send-btn:hover {
    background: #2d4d9a;
}
.msg-row.me {
    flex-direction: row-reverse;
}
.msg-bubble {
    max-width: 420px;
    min-width: 48px;
    width: fit-content;
    padding: 0.7em 1em;
    border-radius: 16px;
    background: #23408e;
    color: #fff;
    margin: 0 0.7em;
    position: relative;
    word-break: break-word;
    font-size: 1em;
    box-sizing: border-box;
}
.msg-row.me .msg-bubble {
    background: #e3eafd;
    color: #23408e;
}
.msg-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #ccc;
    object-fit: cover;
    display: inline-block;
}
.msg-meta {
    font-size: 0.8em;
    color: #888;
    margin-top: 0.2em;
    text-align: right;
}
.msg-row.me .msg-meta {
    text-align: left;
}
.chat-form {
    display: flex;
    gap: 0.5em;
    margin-top: 1em;
}
.chat-form textarea {
    flex: 1;
    border-radius: 8px;
    border: 1px solid #ccc;
    padding: 0.7em;
    resize: none;
}
.chat-form button {
    background: #23408e;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.7em 1.2em;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.2s;
}
.chat-form button:hover {
    background: #2d4d9a;
}
</style>
<div class="chat-container">
    <div style="margin-bottom: 1em;">
        <a href="{% url 'aurora_store:chat_list' %}" style="color:#23408e;text-decoration:none;font-weight:bold;">‚Üê Chats</a>
    </div>
    <div class="chat-messages" id="chat-messages">
        {% for message in messages %}
            <div class="msg-row{% if message.sender == request.user %} me{% endif %}" data-message-id="{{ message.id }}"{% if message.sender == request.user %} onclick="showMessageMenu(event, '{{ message.id }}', '{{ message.sender.id }}', '{{ request.user.id }}')"{% endif %}>
                {% if message.sender.profile.photo %}
                    <img src="{{ message.sender.profile.photo.url }}" class="msg-avatar" alt="avatar">
                {% else %}
                    <span class="msg-avatar" style="background:#ccc;text-align:center;line-height:36px;">{{ message.sender.username|slice:":1"|upper }}</span>
                {% endif %}
                    <div style="position:relative;">
                        <div class="msg-bubble">
                        {% if message.text %}
                            <p>{{ message.text }}</p>
                        {% endif %}

                        {% if message.media %}
                            {% if message.is_image %}
                                <img src="{{ message.media.url }}" style="max-width:200px;border-radius:8px;">
                            {% elif message.is_video %}
                                <video controls style="max-width:200px;border-radius:8px;">
                                    <source src="{{ message.media.url }}">
                                    Your browser does not support video.
                                </video>
                            {% endif %}
                        {% endif %}
                    </div>
                    <div class="msg-meta">{{ message.sender.username }} ‚Ä¢ {{ message.created_at|date:'d.m.Y H:i' }}</div>
                    {% if message.sender == request.user %}
                    <div class="msg-menu" id="msg-menu-{{ message.id }}" style="display:none;position:absolute;top:30px;right:0;z-index:10;background:#fff;border:1px solid #ccc;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);min-width:120px;">
                        <button type="button" onclick="editMessage('{{ message.id }}')" style="width:100%;border:none;background:none;padding:0.7em 1em;text-align:left;cursor:pointer;">Edit</button>
                        <button type="button" onclick="deleteMessage('{{ message.id }}')" style="width:100%;border:none;background:none;padding:0.7em 1em;text-align:left;cursor:pointer;color:#c00;">Delete</button>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% empty %}
            <div style="text-align:center;color:#888;">No messages</div>
        {% endfor %}
    </div>
    <form method="post" enctype="multipart/form-data" class="chat-form">
    {% csrf_token %}
        <textarea name="text" rows="2" placeholder="Enter your message..."></textarea>
        <input type="file" id="media-input" name="media" accept="image/*,video/*" style="display:none;">
        <label for="media-input" class="attach-btn" title="file">üîó</label>
        <button type="submit" class="send-btn">‚û§</button>
    </form>
</div>
<script>
// Scroll to bottom on load
window.onload = function() {
    var chatBox = document.getElementById('chat-messages');
    chatBox.scrollTop = chatBox.scrollHeight;
};

// –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–µ–Ω—é –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
function showMessageMenu(event, messageId, senderId, userId) {
    if (senderId !== userId) return;
    event.stopPropagation();
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –º–µ–Ω—é
    document.querySelectorAll('.msg-menu').forEach(function(menu) { menu.style.display = 'none'; });
    var menu = document.getElementById('msg-menu-' + messageId);
    if (menu) menu.style.display = 'block';
    document.addEventListener('click', hideAllMenus, { once: true });
}
function hideAllMenus() {
    document.querySelectorAll('.msg-menu').forEach(function(menu) { menu.style.display = 'none'; });
}
// –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ AJAX
function deleteMessage(id) {
    fetch(`/messages/${id}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.querySelector(`[data-message-id="${id}"]`).remove();
        }
        hideAllMenus();
    });
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ prompt –∏ AJAX
function editMessage(id) {
    const msgRow = document.querySelector(`[data-message-id="${id}"] .msg-bubble`);
    const oldText = msgRow.textContent;
    const newText = prompt('–ò–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:', oldText);
    if (newText === null || newText.trim() === '' || newText === oldText) {
        hideAllMenus();
        return;
    }
    fetch(`/messages/${id}/edit/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `text=${encodeURIComponent(newText)}`
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            msgRow.textContent = data.text;
        } else if (data.error) {
            alert(data.error);
        }
        hideAllMenus();
    });
}

// –ü–æ–ª—É—á–∏—Ç—å CSRF-—Ç–æ–∫–µ–Ω –∏–∑ cookie
function getCSRFToken() {
    let name = 'csrftoken=';
    let decodedCookie = decodeURIComponent(document.cookie);
    let ca = decodedCookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1);
        if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
    }
    return '';
}
</script>
{% endblock %}
